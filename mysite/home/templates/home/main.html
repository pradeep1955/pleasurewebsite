{% extends "base_bootstrap.html" %}
{% load static %}

{% block content %}

<div class="container page-content">

    <header class="text-center page-header-custom">
    <h3>AI generated stock market analysis, News summary, & Weather report</h3>
    <p>Ask a question on the chatbot below, read the blog, or explore my data science projects.</p>
    <p class="small"><strong>Disclaimer:</strong> This content is AI generated and not investment advice.</p>
    </header>

    <hr>

    <div class="content-section">
        <h2>Stock Market Analysis</h2>
        <iframe src="{% url 'stock_chart' %}" style="width:100%; height:600px; border:none;"></iframe>
    </div>

    <hr>

    <div class="content-section">
        <h2>Today's News <small>(AI Generated)</small></h2>
        <div class="news-content" style="border: 1px solid #eee; padding: 15px; border-radius: 5px;">
            {{ news_summary|safe }}
        </div>
    </div>

    <hr>

    <div class="content-section">
        <h2>Room Sensor Data</h2>
        <div class="row">
            <div class="col-md-4">
                <h4>Current Readings</h4>
                <p>
                    ðŸŒ¡ Temperature: <strong>{{ temperature|floatformat:1 }} Â°C</strong><br>
                    ðŸ’§ Humidity: <strong>{{ humidity|floatformat:1 }} %</strong><br>
                    <em><small>Last updated: {{ last_updated }}</small></em>
                </p>
            </div>
            <div class="col-md-8">
                <h4>Chart (Last 12 Hours)</h4>
                <canvas id="sensorChart"></canvas>
            </div>
        </div>
    </div>

    <hr>

    <div class="content-section">
        <h2>Chatbot</h2>
        <div id="chatbox" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; border-radius: 5px; margin-bottom: 10px;">
            </div>
        <form id="chat-form" method="POST">
            {% csrf_token %}
            <div class="input-group">
                <input type="text" id="user-input" class="form-control" placeholder="Type your message..." required />
                <span class="input-group-btn">
                    <button class="btn btn-primary" type="submit">Send</button>
                </span>
            </div>
        </form>
    </div>

    <hr>

    <footer>
        <p class="text-center">&copy; 2024 Pradeep Chowdhary</p>
    </footer>

</div> <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const ctx = document.getElementById('sensorChart').getContext('2d');
const sensorChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ labels|safe }},
        datasets: [
            {
                label: 'ðŸŒ¡ Temperature (Â°C)',
                data: {{ temperature_data|safe }},
                borderColor: 'red',
                tension: 0.1
            },
            {
                label: 'ðŸ’§ Humidity (%)',
                data: {{ humidity_data|safe }},
                borderColor: 'blue',
                tension: 0.1
            }
        ]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: false } }
    }
});
</script>

<script>
$(document).ready(function() {
    $('#chat-form').on('submit', function(e) {
        e.preventDefault();
        var userInput = $('#user-input').val().trim();
        if (userInput === "") return; // Don't send empty messages

        $('#chatbox').append('<div style="text-align: right; margin: 5px;"><strong>You:</strong> ' + userInput + '</div>');
        $('#user-input').val('');
        
        // Scroll chatbox to the bottom
        $('#chatbox').scrollTop($('#chatbox')[0].scrollHeight);

        $.ajax({
            url: "{% url 'chatbot' %}", // Use the Django URL tag
            type: 'POST',
            contentType: 'application/json',
            headers: {'X-CSRFToken': '{{ csrf_token }}'}, // Include CSRF token in header
            data: JSON.stringify({'message': userInput}),
            success: function(response) {
                $('#chatbox').append('<div style="text-align: left; margin: 5px;"><strong>Bot:</strong> ' + response.message + '</div>');
                $('#chatbox').scrollTop($('#chatbox')[0].scrollHeight);
            },
            error: function(xhr, status, error) {
                console.log("Error: " + error);
                $('#chatbox').append('<div style="color: red;">Error communicating with the bot.</div>');
            }
        });
    });
});
</script>

{% endblock content %}
